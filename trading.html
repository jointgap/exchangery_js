<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>The Exchangery Demo Trading Screen</title>

    <meta name="description" content="A sample trading screen.">
    <meta name="author" content="The Exchangery">

    <link rel="stylesheet" href="css/style.css">

    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

</head>
<body class="index">

    <header>
        <div class="inner">

            <h1>The Exchangery</h1>

            <nav>
                <ul>
                    <li><a href="index.html" title="Home">Home</a></li>
                    <li><a href="faq.html" title="Frequently Asked Questions">FAQ</a></li>
		    <li><a href="trading.html" title="Trading" class="active">Trading Demo</a></li>
                    <li><a href="account.html" title="Account Demo" class="">Account Demo</a></li>
                </ul>
            </nav>

        </div>
    </header>

    <div id="intro" class="intro">
        <div class="inner">

            <h2>Trading Demo</h2>

        </div>
    </div>

    <div id="body">
        <div class="inner">

	  <table id="products"> 
	    <thead> 
	      <tr> 
		<td width="20%">product</td> 
		<td width="20%">bid quantity</td> 
		<td width="20%">bid</td> 
		<td width="20%">offer</td> 
		<td width="20%">offer quantity</td> 
	      </tr> 
	    </thead> 
	    <tbody> 
	    </tbody> 
	  </table> 

            <form id="order">
                <label>Symbol:</label>
                <select type="text" id="symbol" name="symbol"></select>

                <label>Side:</label>
                <select id="side" name="side">
                    <option value="buy">buy</option>
                    <option value="sell">sell</option>
                </select>

                <label>Quantity:</label>
                <input type="text" id="quantity" name="quantity" min="1">

                <label>Price:</label>
                <input type="text" id="price" name="price" min="0">

                <input type="submit" value="Place Order" class="button">
            </form>
	    
        </div>
    </div>

    <div id="signup" class="focus">
        <div class="inset">
            <div class="inner">

                <p class="big column five">Sign up for our newsletter and get updates and early access.</p>

                <div class="column seven last">
                    <form id="newsletter">
                        <input type="text" name="email" placeholder="you@example.com">
                        <input type="submit" name="submit" value="Get Notified" class="button">
                    </form>
                </div>

            </div>
        </div>
    </div>

    <footer>
        <div class="inner">

            <p>&copy; 2011 The Exchangery.</p>

        </div>
    </footer>

    <!-- script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script -->
    <script>!window.jQuery && document.write('<script src="js/jquery.js"><\/script>')</script>
    <script src="js/exchng.js" type="text/javascript"></script>

    <script type="text/javascript">
       $(document).ready(function(){
		$.ajax({
			type: 'POST',
			url: 'ts/login', 
			contentType: 'application/json; charset=utf-8', 
			dataType: 'json',
			processData : false,
			data: JSON.stringify({username : "demo", password : "demo"}),
			success: function(data) {
				console.log(data);
                load_market();
			}
		});	
   	});
    </script>

    <script type="text/javascript">
    	var exchng;
      	function load_market() {
  		 	exchng= new Exchng("123", function(event) {
				switch(event['name']) {
					case 'fetch-complete':
						draw_market();
						break;
				}
			});
			$('#order').submit(function() {
				requestData = {
					order: {
						market_id: exchng.marketId,
						product_id: $('[name=symbol]').val(),
						side: $('[name=side]').val(),
						quantity: $('[name=quantity]').val(),
						price: $('[name=price]').val(),
					}
				};
				$.ajax({
					type: 'POST',
					url: 'ts/orders', 
					contentType: 'application/json; charset=utf-8', 
					dataType: 'json',
					processData : false,
					data: JSON.stringify(requestData),
					success: function(data) {
						console.log(data);
					}
				});
				return false;
			});
			exchng.fetchData();
			/*												throwing exception on $.each
			exchng.beginPoll(function(orders) {
				console.log(orders);
				
				$.each(orders, function(index, order) {
					console.log("received order: " + order);
					var product = exchng.products[order.product_id];
					product.addOrder(order);
				});
				
			});
			*/
		};
		function draw_market() {
		  		$('#order [name=symbol] option').addClass('marked');
				$.each(exchng.products, function() {
					if($('#order [name=symbol] option:contains(' + this['symbol'] + ')').removeClass('marked').length == 0) {
						$('#order [name=symbol]').append($('<option value=' + this['id'] + '></option>').text(this['symbol']));
					}
				});
				$('#order [name=symbol] option.marked').detach();
				$('#products tbody').empty();
				$.each(exchng.products, function() {
					var product = this;
					$.each(this['details'], function() {
						var detail = this;
						var tr = $('<tr></tr>');
						if(!detail['best']) {
							tr.css('display', 'none');
						}
						tr.append($('<td></td>').text(product['symbol']));
						$.each(['bid_quantity', 'bid', 'offer', 'offer_quantity'], function() {
							if(detail[this]) {
								tr.append($('<td></td>').text(detail[this]));
							} else {
								tr.append($('<td></td>'));
							}
						});
						$('#products tbody').append(tr);
					});
				});
		  };
    </script> 

    <script type="text/javascript">
      $('#newsletter').submit(function() {
			requestData = { email: $('[name=email]').val() };			
			$.ajax({
				type: 'POST',
				url: 'list/subscribe', 
				contentType: 'application/json; charset=utf-8', 
				dataType: 'json',
				processData : false,
				data: JSON.stringify(requestData),
				success: function(data) {
					console.log(data);
				}
			});
			return false;
		});
    </script>

</body>
</html>
